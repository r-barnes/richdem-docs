<?xml version='1.0' encoding='UTF-8' standalone='no'?>
<doxygen xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:noNamespaceSchemaLocation="compound.xsd" version="1.8.13">
  <compounddef id="flat__resolution_8hpp" kind="file" language="C++">
    <compoundname>flat_resolution.hpp</compoundname>
    <includes refid="logger_8hpp" local="yes">richdem/common/logger.hpp</includes>
    <includes refid="ProgressBar_8hpp" local="yes">richdem/common/ProgressBar.hpp</includes>
    <includes refid="grid__cell_8hpp" local="yes">richdem/common/grid_cell.hpp</includes>
    <includes refid="d8__flowdirs_8hpp" local="yes">richdem/flowmet/d8_flowdirs.hpp</includes>
    <includes local="no">deque</includes>
    <includes local="no">vector</includes>
    <includes local="no">queue</includes>
    <includes local="no">cmath</includes>
    <includes local="no">limits</includes>
    <includedby refid="flat__resolution__dinf_8hpp" local="yes">/z/richdem/include/richdem/flats/flat_resolution_dinf.hpp</includedby>
    <includedby refid="flats_2main_8cpp" local="yes">/z/richdem/include/richdem/flats/main.cpp</includedby>
    <includedby refid="richdem_8hpp" local="yes">/z/richdem/include/richdem/richdem.hpp</includedby>
    <incdepgraph>
      <node id="519">
        <label>richdem/common/ProgressBar.hpp</label>
        <link refid="ProgressBar_8hpp"/>
        <childnode refid="518" relation="include">
        </childnode>
        <childnode refid="516" relation="include">
        </childnode>
        <childnode refid="520" relation="include">
        </childnode>
        <childnode refid="521" relation="include">
        </childnode>
        <childnode refid="522" relation="include">
        </childnode>
        <childnode refid="523" relation="include">
        </childnode>
      </node>
      <node id="520">
        <label>iomanip</label>
      </node>
      <node id="526">
        <label>queue</label>
      </node>
      <node id="535">
        <label>limits</label>
      </node>
      <node id="527">
        <label>cmath</label>
      </node>
      <node id="532">
        <label>cassert</label>
      </node>
      <node id="522">
        <label>stdexcept</label>
      </node>
      <node id="518">
        <label>string</label>
      </node>
      <node id="529">
        <label>richdem/common/Array2D.hpp</label>
        <link refid="Array2D_8hpp"/>
        <childnode refid="530" relation="include">
        </childnode>
        <childnode refid="525" relation="include">
        </childnode>
        <childnode refid="516" relation="include">
        </childnode>
        <childnode refid="531" relation="include">
        </childnode>
        <childnode refid="520" relation="include">
        </childnode>
        <childnode refid="532" relation="include">
        </childnode>
        <childnode refid="533" relation="include">
        </childnode>
        <childnode refid="534" relation="include">
        </childnode>
        <childnode refid="522" relation="include">
        </childnode>
        <childnode refid="535" relation="include">
        </childnode>
        <childnode refid="536" relation="include">
        </childnode>
        <childnode refid="537" relation="include">
        </childnode>
        <childnode refid="538" relation="include">
        </childnode>
        <childnode refid="515" relation="include">
        </childnode>
        <childnode refid="539" relation="include">
        </childnode>
        <childnode refid="540" relation="include">
        </childnode>
        <childnode refid="541" relation="include">
        </childnode>
      </node>
      <node id="538">
        <label>map</label>
      </node>
      <node id="537">
        <label>unordered_set</label>
      </node>
      <node id="531">
        <label>fstream</label>
      </node>
      <node id="528">
        <label>richdem/flowmet/d8_flowdirs.hpp</label>
        <link refid="d8__flowdirs_8hpp"/>
        <childnode refid="515" relation="include">
        </childnode>
        <childnode refid="529" relation="include">
        </childnode>
        <childnode refid="519" relation="include">
        </childnode>
      </node>
      <node id="534">
        <label>typeinfo</label>
      </node>
      <node id="539">
        <label>richdem/common/version.hpp</label>
        <link refid="version_8hpp"/>
        <childnode refid="518" relation="include">
        </childnode>
        <childnode refid="516" relation="include">
        </childnode>
      </node>
      <node id="536">
        <label>ctime</label>
      </node>
      <node id="525">
        <label>vector</label>
      </node>
      <node id="514">
        <label>/z/richdem/include/richdem/flats/flat_resolution.hpp</label>
        <link refid="flat__resolution_8hpp"/>
        <childnode refid="515" relation="include">
        </childnode>
        <childnode refid="519" relation="include">
        </childnode>
        <childnode refid="524" relation="include">
        </childnode>
        <childnode refid="528" relation="include">
        </childnode>
        <childnode refid="543" relation="include">
        </childnode>
        <childnode refid="525" relation="include">
        </childnode>
        <childnode refid="526" relation="include">
        </childnode>
        <childnode refid="527" relation="include">
        </childnode>
        <childnode refid="535" relation="include">
        </childnode>
      </node>
      <node id="517">
        <label>sstream</label>
      </node>
      <node id="521">
        <label>sys/time.h</label>
      </node>
      <node id="516">
        <label>iostream</label>
      </node>
      <node id="543">
        <label>deque</label>
      </node>
      <node id="541">
        <label>richdem/common/ManagedVector.hpp</label>
        <link refid="ManagedVector_8hpp_source"/>
        <childnode refid="542" relation="include">
        </childnode>
      </node>
      <node id="530">
        <label>gdal.hpp</label>
        <link refid="gdal_8hpp_source"/>
      </node>
      <node id="523">
        <label>richdem/common/timer.hpp</label>
        <link refid="timer_8hpp"/>
        <childnode refid="521" relation="include">
        </childnode>
        <childnode refid="522" relation="include">
        </childnode>
      </node>
      <node id="540">
        <label>richdem/common/constants.hpp</label>
        <link refid="constants_8hpp"/>
      </node>
      <node id="533">
        <label>algorithm</label>
      </node>
      <node id="542">
        <label>memory</label>
      </node>
      <node id="524">
        <label>richdem/common/grid_cell.hpp</label>
        <link refid="grid__cell_8hpp"/>
        <childnode refid="525" relation="include">
        </childnode>
        <childnode refid="526" relation="include">
        </childnode>
        <childnode refid="527" relation="include">
        </childnode>
      </node>
      <node id="515">
        <label>richdem/common/logger.hpp</label>
        <link refid="logger_8hpp_source"/>
        <childnode refid="516" relation="include">
        </childnode>
        <childnode refid="517" relation="include">
        </childnode>
        <childnode refid="518" relation="include">
        </childnode>
      </node>
    </incdepgraph>
    <invincdepgraph>
      <node id="545">
        <label>/z/richdem/include/richdem/flats/flat_resolution_dinf.hpp</label>
        <link refid="flat__resolution__dinf_8hpp"/>
        <childnode refid="546" relation="include">
        </childnode>
      </node>
      <node id="544">
        <label>/z/richdem/include/richdem/flats/flat_resolution.hpp</label>
        <link refid="flat__resolution_8hpp"/>
        <childnode refid="545" relation="include">
        </childnode>
        <childnode refid="546" relation="include">
        </childnode>
      </node>
      <node id="546">
        <label>/z/richdem/include/richdem/richdem.hpp</label>
        <link refid="richdem_8hpp_source"/>
      </node>
    </invincdepgraph>
    <innernamespace refid="namespacerichdem">richdem</innernamespace>
    <briefdescription>
<para>Resolve flats according to Barnes (2014) </para>    </briefdescription>
    <detaileddescription>
<para><simplesect kind="author"><para>Richard Barnes (<ulink url="mailto:rbarnes@umn.edu">rbarnes@umn.edu</ulink>), 2012</para></simplesect>
Contains code to generate an elevation mask which is guaranteed to drain a flat using a convergent flow pattern (unless it&apos;s a mesa) </para>    </detaileddescription>
    <programlisting>
<codeline lineno="1"></codeline>
<codeline lineno="9"><highlight class="preprocessor">#ifndef<sp/>_richdem_flat_resolution_hpp_</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="10"><highlight class="normal"></highlight><highlight class="preprocessor">#define<sp/>_richdem_flat_resolution_hpp_</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="11"><highlight class="normal"></highlight></codeline>
<codeline lineno="12"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;richdem/common/logger.hpp&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="13"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="ProgressBar_8hpp" kindref="compound">richdem/common/ProgressBar.hpp</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="14"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="grid__cell_8hpp" kindref="compound">richdem/common/grid_cell.hpp</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="15"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&quot;<ref refid="d8__flowdirs_8hpp" kindref="compound">richdem/flowmet/d8_flowdirs.hpp</ref>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="16"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;deque&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="17"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;vector&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="18"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;queue&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="19"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;cmath&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="20"><highlight class="normal"></highlight><highlight class="preprocessor">#include<sp/>&lt;limits&gt;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="21"><highlight class="normal"></highlight></codeline>
<codeline lineno="22"><highlight class="normal"></highlight><highlight class="keyword">namespace<sp/></highlight><highlight class="normal"><ref refid="namespacerichdem" kindref="compound">richdem</ref><sp/>{</highlight></codeline>
<codeline lineno="23"><highlight class="normal"></highlight></codeline>
<codeline lineno="24"><highlight class="normal"></highlight><highlight class="comment">//234</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="25"><highlight class="normal"></highlight><highlight class="comment">//105</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="26"><highlight class="normal"></highlight><highlight class="comment">//876</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="27"><highlight class="normal"></highlight><highlight class="comment">//d8_masked_FlowDir</highlight></codeline>
<codeline lineno="42"><highlight class="comment"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>d8_masked_FlowDir(</highlight></codeline>
<codeline lineno="43"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Array2D&lt;int32_t&gt;<sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="44"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>Array2D&lt;int32_t&gt;<sp/>&amp;labels,</highlight></codeline>
<codeline lineno="45"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x,</highlight></codeline>
<codeline lineno="46"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y</highlight></codeline>
<codeline lineno="47"><highlight class="normal">){</highlight></codeline>
<codeline lineno="48"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>minimum_elevation=flat_mask(x,y);</highlight></codeline>
<codeline lineno="49"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>flowdir=<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref>;</highlight></codeline>
<codeline lineno="50"><highlight class="normal"></highlight></codeline>
<codeline lineno="51"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//It<sp/>is<sp/>safe<sp/>to<sp/>do<sp/>this<sp/>without<sp/>checking<sp/>to<sp/>see<sp/>that<sp/>(nx,ny)<sp/>is<sp/>within</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="52"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//the<sp/>grid<sp/>because<sp/>we<sp/>only<sp/>call<sp/>this<sp/>function<sp/>on<sp/>interior<sp/>cells</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="53"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;n++){</highlight></codeline>
<codeline lineno="54"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nx=x+<ref refid="constants_8hpp_1aa5b197c553cb75cc5bed18478bbeab41" kindref="member">dx</ref>[n];</highlight></codeline>
<codeline lineno="55"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ny=y+<ref refid="constants_8hpp_1a8eee3f4a3891f1bd2c44ce2df9df4fb6" kindref="member">dy</ref>[n];</highlight></codeline>
<codeline lineno="56"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/>labels(nx,ny)!=labels(x,y))</highlight></codeline>
<codeline lineno="57"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="58"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(<sp/><sp/>flat_mask(nx,ny)&lt;minimum_elevation<sp/>||<sp/>(flat_mask(nx,ny)==minimum_elevation<sp/>&amp;&amp;<sp/>flowdir&gt;0<sp/>&amp;&amp;<sp/>flowdir%2==0<sp/>&amp;&amp;<sp/>n%2==1)<sp/>){</highlight></codeline>
<codeline lineno="59"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>minimum_elevation=flat_mask(nx,ny);</highlight></codeline>
<codeline lineno="60"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>flowdir=n;</highlight></codeline>
<codeline lineno="61"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="62"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="63"><highlight class="normal"></highlight></codeline>
<codeline lineno="64"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal"><sp/>flowdir;</highlight></codeline>
<codeline lineno="65"><highlight class="normal">}</highlight></codeline>
<codeline lineno="66"><highlight class="normal"></highlight></codeline>
<codeline lineno="67"><highlight class="normal"></highlight><highlight class="comment">//d8_flow_flats</highlight></codeline>
<codeline lineno="96"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="97" refid="flat__resolution_8hpp_1ad1f33db1167def82613eb31a59dfecb7" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="flat__resolution_8hpp_1ad1f33db1167def82613eb31a59dfecb7" kindref="member">d8_flow_flats</ref>(</highlight></codeline>
<codeline lineno="98"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="99"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels,</highlight></codeline>
<codeline lineno="100"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/>&amp;flowdirs</highlight></codeline>
<codeline lineno="101"><highlight class="normal">){</highlight></codeline>
<codeline lineno="102"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1ProgressBar" kindref="compound">ProgressBar</ref><sp/>progress;</highlight></codeline>
<codeline lineno="103"><highlight class="normal"></highlight></codeline>
<codeline lineno="104"><highlight class="normal"><sp/><sp/>RDLOG_ALG_NAME&lt;&lt;</highlight><highlight class="stringliteral">&quot;Calculating<sp/>D8<sp/>flow<sp/>directions<sp/>using<sp/>flat<sp/>mask...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="105"><highlight class="normal"><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1a00e1878d9af52da7397d5965d923bbbd" kindref="member">start</ref>(<sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>()*flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="106"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/>#pragma<sp/>omp<sp/>parallel<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="107"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x=1;x&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>()-1;x++){</highlight></codeline>
<codeline lineno="108"><highlight class="normal"><sp/><sp/><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1aa71fef0e8019c8dd64ed7c7e79466511" kindref="member">update</ref>(<sp/>x*flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="109"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y=1;y&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()-1;y++)</highlight></codeline>
<codeline lineno="110"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flat_mask(x,y)==flat_mask.<ref refid="classrichdem_1_1Array2D_1a80cb5415f73417724bb7fee3da21303a" kindref="member">noData</ref>())</highlight></codeline>
<codeline lineno="111"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="112"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal"><sp/>(flowdirs(x,y)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref>)</highlight></codeline>
<codeline lineno="113"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>flowdirs(x,y)=d8_masked_FlowDir(flat_mask,labels,x,y);</highlight></codeline>
<codeline lineno="114"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="115"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Succeeded<sp/>in<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;progress.<ref refid="classrichdem_1_1ProgressBar_1a69063c770d5eaee6299590de1d0294b6" kindref="member">stop</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="116"><highlight class="normal">}</highlight></codeline>
<codeline lineno="117"><highlight class="normal"></highlight></codeline>
<codeline lineno="118"><highlight class="normal"></highlight><highlight class="comment">//Procedure:<sp/>BuildAwayGradient</highlight></codeline>
<codeline lineno="152"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="153"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>BuildAwayGradient(</highlight></codeline>
<codeline lineno="154"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flowdirs,</highlight></codeline>
<codeline lineno="155"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="156"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/><sp/>edges,</highlight></codeline>
<codeline lineno="157"><highlight class="normal"><sp/><sp/>std::vector&lt;int&gt;<sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flat_height,</highlight></codeline>
<codeline lineno="158"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels</highlight></codeline>
<codeline lineno="159"><highlight class="normal">){</highlight></codeline>
<codeline lineno="160"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Timer" kindref="compound">Timer</ref><sp/>timer;</highlight></codeline>
<codeline lineno="161"><highlight class="normal"><sp/><sp/>timer.<ref refid="classrichdem_1_1Timer_1a6c1403aed0cc07ac87309e63a87d2217" kindref="member">start</ref>();</highlight></codeline>
<codeline lineno="162"><highlight class="normal"></highlight></codeline>
<codeline lineno="163"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>loops<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="164"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref><sp/>iteration_marker(-1,-1);</highlight></codeline>
<codeline lineno="165"><highlight class="normal"></highlight></codeline>
<codeline lineno="166"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Performing<sp/>Barnes<sp/>flat<sp/>resolution&apos;s<sp/>away<sp/>gradient...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="167"><highlight class="normal"></highlight></codeline>
<codeline lineno="168"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//Incrementation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="169"><highlight class="normal"><sp/><sp/>edges.push_back(iteration_marker);</highlight></codeline>
<codeline lineno="170"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(edges.size()!=1){<sp/><sp/></highlight><highlight class="comment">//Only<sp/>iteration<sp/>marker<sp/>is<sp/>left<sp/>in<sp/>the<sp/>end</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="171"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x<sp/>=<sp/>edges.front().x;</highlight></codeline>
<codeline lineno="172"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y<sp/>=<sp/>edges.front().y;</highlight></codeline>
<codeline lineno="173"><highlight class="normal"><sp/><sp/><sp/><sp/>edges.pop_front();</highlight></codeline>
<codeline lineno="174"><highlight class="normal"></highlight></codeline>
<codeline lineno="175"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(x==-1){<sp/><sp/></highlight><highlight class="comment">//I&apos;m<sp/>an<sp/>iteration<sp/>marker</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="176"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>loops++;</highlight></codeline>
<codeline lineno="177"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>edges.push_back(iteration_marker);</highlight></codeline>
<codeline lineno="178"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="179"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="180"><highlight class="normal"></highlight></codeline>
<codeline lineno="181"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flat_mask(x,y)&gt;0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/><sp/></highlight><highlight class="comment">//I&apos;ve<sp/>already<sp/>been<sp/>incremented!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="182"><highlight class="normal"></highlight></codeline>
<codeline lineno="183"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//If<sp/>I<sp/>incremented,<sp/>maybe<sp/>my<sp/>neighbours<sp/>should<sp/>too</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="184"><highlight class="normal"><sp/><sp/><sp/><sp/>flat_mask(x,y)=loops;</highlight></codeline>
<codeline lineno="185"><highlight class="normal"><sp/><sp/><sp/><sp/>flat_height[labels(x,y)]=loops;</highlight></codeline>
<codeline lineno="186"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;n++){</highlight></codeline>
<codeline lineno="187"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nx<sp/>=<sp/>x+dx[n];</highlight></codeline>
<codeline lineno="188"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ny<sp/>=<sp/>y+dy[n];</highlight></codeline>
<codeline lineno="189"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels.<ref refid="classrichdem_1_1Array2D_1abf160c36c4e75a94e959c0e77472989c" kindref="member">inGrid</ref>(nx,ny)</highlight></codeline>
<codeline lineno="190"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>labels(nx,ny)==labels(x,y)</highlight></codeline>
<codeline lineno="191"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>flowdirs(nx,ny)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref>)</highlight></codeline>
<codeline lineno="192"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>edges.push_back(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(nx,ny));</highlight></codeline>
<codeline lineno="193"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="194"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="195"><highlight class="normal"></highlight></codeline>
<codeline lineno="196"><highlight class="normal"><sp/><sp/>timer.<ref refid="classrichdem_1_1Timer_1a94adfb2b628004e774b8d8ac4d6654b2" kindref="member">stop</ref>();</highlight></codeline>
<codeline lineno="197"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Succeeded<sp/>in<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;timer.<ref refid="classrichdem_1_1Timer_1a3866ded735d646bf1749eb4c553a7b75" kindref="member">accumulated</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="198"><highlight class="normal">}</highlight></codeline>
<codeline lineno="199"><highlight class="normal"></highlight></codeline>
<codeline lineno="200"><highlight class="normal"></highlight></codeline>
<codeline lineno="201"><highlight class="normal"></highlight></codeline>
<codeline lineno="202"><highlight class="normal"></highlight><highlight class="comment">//Procedure:<sp/>BuildTowardsCombinedGradient</highlight></codeline>
<codeline lineno="241"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="242"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>BuildTowardsCombinedGradient(</highlight></codeline>
<codeline lineno="243"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flowdirs,</highlight></codeline>
<codeline lineno="244"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="245"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/><sp/>edges,</highlight></codeline>
<codeline lineno="246"><highlight class="normal"><sp/><sp/>std::vector&lt;int&gt;<sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flat_height,</highlight></codeline>
<codeline lineno="247"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels</highlight></codeline>
<codeline lineno="248"><highlight class="normal">){</highlight></codeline>
<codeline lineno="249"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Timer" kindref="compound">Timer</ref><sp/>timer;</highlight></codeline>
<codeline lineno="250"><highlight class="normal"><sp/><sp/>timer.<ref refid="classrichdem_1_1Timer_1a6c1403aed0cc07ac87309e63a87d2217" kindref="member">start</ref>();</highlight></codeline>
<codeline lineno="251"><highlight class="normal"></highlight></codeline>
<codeline lineno="252"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>loops<sp/>=<sp/>1;</highlight></codeline>
<codeline lineno="253"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref><sp/>iteration_marker(-1,-1);</highlight></codeline>
<codeline lineno="254"><highlight class="normal"></highlight></codeline>
<codeline lineno="255"><highlight class="normal"></highlight></codeline>
<codeline lineno="256"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Barnes<sp/>flat<sp/>resolution:<sp/>toward<sp/>and<sp/>combined<sp/>gradients...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="257"><highlight class="normal"></highlight></codeline>
<codeline lineno="258"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//Make<sp/>previous<sp/>flat_mask<sp/>negative<sp/>so<sp/>that<sp/>we<sp/>can<sp/>keep<sp/>track<sp/>of<sp/>where<sp/>we<sp/>are</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="259"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/>#pragma<sp/>omp<sp/>parallel<sp/>for<sp/>collapse(2)</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="260"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x=0;x&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>();x++)</highlight></codeline>
<codeline lineno="261"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y=0;y&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>();y++)</highlight></codeline>
<codeline lineno="262"><highlight class="normal"><sp/><sp/><sp/><sp/>flat_mask(x,y)*=-1;</highlight></codeline>
<codeline lineno="263"><highlight class="normal"></highlight></codeline>
<codeline lineno="264"><highlight class="normal"></highlight></codeline>
<codeline lineno="265"><highlight class="normal"><sp/><sp/></highlight><highlight class="comment">//Incrementation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="266"><highlight class="normal"><sp/><sp/>edges.push_back(iteration_marker);</highlight></codeline>
<codeline lineno="267"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(edges.size()!=1){<sp/><sp/></highlight><highlight class="comment">//Only<sp/>iteration<sp/>marker<sp/>is<sp/>left<sp/>in<sp/>the<sp/>end</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="268"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x<sp/>=<sp/>edges.front().x;</highlight></codeline>
<codeline lineno="269"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y<sp/>=<sp/>edges.front().y;</highlight></codeline>
<codeline lineno="270"><highlight class="normal"><sp/><sp/><sp/><sp/>edges.pop_front();</highlight></codeline>
<codeline lineno="271"><highlight class="normal"></highlight></codeline>
<codeline lineno="272"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(x==-1){<sp/><sp/></highlight><highlight class="comment">//I&apos;m<sp/>an<sp/>iteration<sp/>marker</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="273"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>loops++;</highlight></codeline>
<codeline lineno="274"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>edges.push_back(iteration_marker);</highlight></codeline>
<codeline lineno="275"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="276"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="277"><highlight class="normal"></highlight></codeline>
<codeline lineno="278"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flat_mask(x,y)&gt;0)<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;<sp/><sp/></highlight><highlight class="comment">//I&apos;ve<sp/>already<sp/>been<sp/>incremented!</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="279"><highlight class="normal"></highlight></codeline>
<codeline lineno="280"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//If<sp/>I<sp/>incremented,<sp/>maybe<sp/>my<sp/>neighbours<sp/>should<sp/>too</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="281"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flat_mask(x,y)!=0)<sp/><sp/></highlight><highlight class="comment">//If<sp/>!=0,<sp/>it<sp/>_will_<sp/>be<sp/>less<sp/>than<sp/>0.</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="282"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>flat_mask(x,y)=(flat_height[labels(x,y)]+flat_mask(x,y))+2*loops;</highlight></codeline>
<codeline lineno="283"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="284"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>flat_mask(x,y)=2*loops;</highlight></codeline>
<codeline lineno="285"><highlight class="normal"></highlight></codeline>
<codeline lineno="286"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;n++){</highlight></codeline>
<codeline lineno="287"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nx<sp/>=<sp/>x+dx[n];</highlight></codeline>
<codeline lineno="288"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ny<sp/>=<sp/>y+dy[n];</highlight></codeline>
<codeline lineno="289"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels.<ref refid="classrichdem_1_1Array2D_1abf160c36c4e75a94e959c0e77472989c" kindref="member">inGrid</ref>(nx,ny)</highlight></codeline>
<codeline lineno="290"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>labels(nx,ny)==labels(x,y)</highlight></codeline>
<codeline lineno="291"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&amp;&amp;<sp/>flowdirs(nx,ny)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref>)</highlight></codeline>
<codeline lineno="292"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>edges.push_back(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(nx,ny));</highlight></codeline>
<codeline lineno="293"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="294"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="295"><highlight class="normal"></highlight></codeline>
<codeline lineno="296"><highlight class="normal"><sp/><sp/>timer.<ref refid="classrichdem_1_1Timer_1a94adfb2b628004e774b8d8ac4d6654b2" kindref="member">stop</ref>();</highlight></codeline>
<codeline lineno="297"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Succeeded<sp/>in<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;timer.<ref refid="classrichdem_1_1Timer_1a3866ded735d646bf1749eb4c553a7b75" kindref="member">accumulated</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="298"><highlight class="normal">}</highlight></codeline>
<codeline lineno="299"><highlight class="normal"></highlight></codeline>
<codeline lineno="300"><highlight class="normal"></highlight></codeline>
<codeline lineno="301"><highlight class="normal"></highlight><highlight class="comment">//Procedure:<sp/>label_this</highlight></codeline>
<codeline lineno="331"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>T&gt;</highlight></codeline>
<codeline lineno="332"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>label_this(</highlight></codeline>
<codeline lineno="333"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x0,</highlight></codeline>
<codeline lineno="334"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y0,</highlight></codeline>
<codeline lineno="335"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>label,</highlight></codeline>
<codeline lineno="336"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels,</highlight></codeline>
<codeline lineno="337"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;T&gt;</ref><sp/>&amp;elevations</highlight></codeline>
<codeline lineno="338"><highlight class="normal">){</highlight></codeline>
<codeline lineno="339"><highlight class="normal"><sp/><sp/>std::queue&lt;GridCell&gt;<sp/>to_fill;</highlight></codeline>
<codeline lineno="340"><highlight class="normal"><sp/><sp/>to_fill.push(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(x0,y0));</highlight></codeline>
<codeline lineno="341"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/>T<sp/>target_elevation<sp/>=<sp/>elevations(x0,y0);</highlight></codeline>
<codeline lineno="342"><highlight class="normal"></highlight></codeline>
<codeline lineno="343"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">while</highlight><highlight class="normal">(to_fill.size()&gt;0){</highlight></codeline>
<codeline lineno="344"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref><sp/>c<sp/>=<sp/>to_fill.front();</highlight></codeline>
<codeline lineno="345"><highlight class="normal"><sp/><sp/><sp/><sp/>to_fill.pop();</highlight></codeline>
<codeline lineno="346"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(elevations(c.<ref refid="classrichdem_1_1GridCell_1ad0720d4f9d57365fc5abe3f4f63e32c9" kindref="member">x</ref>,c.<ref refid="classrichdem_1_1GridCell_1acdf9ef83d894321472076b7562356485" kindref="member">y</ref>)!=target_elevation)</highlight></codeline>
<codeline lineno="347"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="348"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels(c.<ref refid="classrichdem_1_1GridCell_1ad0720d4f9d57365fc5abe3f4f63e32c9" kindref="member">x</ref>,c.<ref refid="classrichdem_1_1GridCell_1acdf9ef83d894321472076b7562356485" kindref="member">y</ref>)&gt;0)</highlight></codeline>
<codeline lineno="349"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="350"><highlight class="normal"><sp/><sp/><sp/><sp/>labels(c.<ref refid="classrichdem_1_1GridCell_1ad0720d4f9d57365fc5abe3f4f63e32c9" kindref="member">x</ref>,c.<ref refid="classrichdem_1_1GridCell_1acdf9ef83d894321472076b7562356485" kindref="member">y</ref>)=label;</highlight></codeline>
<codeline lineno="351"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;n++)</highlight></codeline>
<codeline lineno="352"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels.<ref refid="classrichdem_1_1Array2D_1abf160c36c4e75a94e959c0e77472989c" kindref="member">inGrid</ref>(c.<ref refid="classrichdem_1_1GridCell_1ad0720d4f9d57365fc5abe3f4f63e32c9" kindref="member">x</ref>+dx[n],c.<ref refid="classrichdem_1_1GridCell_1acdf9ef83d894321472076b7562356485" kindref="member">y</ref>+dy[n]))</highlight></codeline>
<codeline lineno="353"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>to_fill.push(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(c.<ref refid="classrichdem_1_1GridCell_1ad0720d4f9d57365fc5abe3f4f63e32c9" kindref="member">x</ref>+dx[n],c.<ref refid="classrichdem_1_1GridCell_1acdf9ef83d894321472076b7562356485" kindref="member">y</ref>+dy[n]));</highlight></codeline>
<codeline lineno="354"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="355"><highlight class="normal">}</highlight></codeline>
<codeline lineno="356"><highlight class="normal"></highlight></codeline>
<codeline lineno="357"><highlight class="normal"></highlight><highlight class="comment">//Procedure:<sp/>find_flat_edges</highlight></codeline>
<codeline lineno="381"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal"><sp/>&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>T,<sp/></highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="382"><highlight class="normal"></highlight><highlight class="keyword">static</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>find_flat_edges(</highlight></codeline>
<codeline lineno="383"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/>&amp;low_edges,</highlight></codeline>
<codeline lineno="384"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/>&amp;high_edges,</highlight></codeline>
<codeline lineno="385"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/>&amp;flowdirs,</highlight></codeline>
<codeline lineno="386"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;T&gt;</ref><sp/><sp/><sp/><sp/><sp/><sp/>&amp;elevations</highlight></codeline>
<codeline lineno="387"><highlight class="normal">){</highlight></codeline>
<codeline lineno="388"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>cells_without_flow=0;</highlight></codeline>
<codeline lineno="389"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1ProgressBar" kindref="compound">ProgressBar</ref><sp/>progress;</highlight></codeline>
<codeline lineno="390"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Searching<sp/>for<sp/>flats...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="391"><highlight class="normal"><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1a00e1878d9af52da7397d5965d923bbbd" kindref="member">start</ref>(<sp/>flowdirs.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>()*flowdirs.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="392"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x=0;x&lt;flowdirs.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>();x++){</highlight></codeline>
<codeline lineno="393"><highlight class="normal"><sp/><sp/><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1aa71fef0e8019c8dd64ed7c7e79466511" kindref="member">update</ref>(<sp/>x*flowdirs.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="394"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y=0;y&lt;flowdirs.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>();y++){</highlight></codeline>
<codeline lineno="395"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flowdirs(x,y)==flowdirs.<ref refid="classrichdem_1_1Array2D_1a80cb5415f73417724bb7fee3da21303a" kindref="member">noData</ref>())</highlight></codeline>
<codeline lineno="396"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="397"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flowdirs(x,y)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref>)</highlight></codeline>
<codeline lineno="398"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>cells_without_flow++;</highlight></codeline>
<codeline lineno="399"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;n++){</highlight></codeline>
<codeline lineno="400"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nx<sp/>=<sp/>x+dx[n];</highlight></codeline>
<codeline lineno="401"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ny<sp/>=<sp/>y+dy[n];</highlight></codeline>
<codeline lineno="402"><highlight class="normal"></highlight></codeline>
<codeline lineno="403"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!flowdirs.<ref refid="classrichdem_1_1Array2D_1abf160c36c4e75a94e959c0e77472989c" kindref="member">inGrid</ref>(nx,ny))<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="404"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flowdirs(nx,ny)==flowdirs.<ref refid="classrichdem_1_1Array2D_1a80cb5415f73417724bb7fee3da21303a" kindref="member">noData</ref>())<sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="405"><highlight class="normal"></highlight></codeline>
<codeline lineno="406"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flowdirs(x,y)!=<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref><sp/>&amp;&amp;<sp/>flowdirs(nx,ny)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref><sp/>&amp;&amp;<sp/>elevations(nx,ny)==elevations(x,y)){</highlight></codeline>
<codeline lineno="407"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>low_edges.push_back(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(x,y));</highlight></codeline>
<codeline lineno="408"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="409"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(flowdirs(x,y)==<ref refid="constants_8hpp_1a09b183c5986b6feec4b3b2ad9edbd144" kindref="member">NO_FLOW</ref><sp/>&amp;&amp;<sp/>elevations(x,y)&lt;elevations(nx,ny)){</highlight></codeline>
<codeline lineno="410"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>high_edges.push_back(<ref refid="classrichdem_1_1GridCell" kindref="compound">GridCell</ref>(x,y));</highlight></codeline>
<codeline lineno="411"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">break</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="412"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="413"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="414"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="415"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="416"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Succeeded<sp/>in<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;progress.<ref refid="classrichdem_1_1ProgressBar_1a69063c770d5eaee6299590de1d0294b6" kindref="member">stop</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="417"><highlight class="normal"><sp/><sp/>RDLOG_MISC&lt;&lt;</highlight><highlight class="stringliteral">&quot;Cells<sp/>with<sp/>no<sp/>flow<sp/>direction<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;cells_without_flow;</highlight></codeline>
<codeline lineno="418"><highlight class="normal">}</highlight></codeline>
<codeline lineno="419"><highlight class="normal"></highlight></codeline>
<codeline lineno="420"><highlight class="normal"></highlight></codeline>
<codeline lineno="421"><highlight class="normal"></highlight><highlight class="comment">//Procedure:<sp/>resolve_flats_barnes</highlight></codeline>
<codeline lineno="447"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal"><sp/>&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>T,<sp/></highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="448" refid="flat__resolution_8hpp_1a5a8557edf0f7687059df9ae900ada909" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="flat__resolution_8hpp_1a5a8557edf0f7687059df9ae900ada909" kindref="member">resolve_flats_barnes</ref>(</highlight></codeline>
<codeline lineno="449"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;T&gt;</ref><sp/>&amp;elevations,</highlight></codeline>
<codeline lineno="450"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/>&amp;flowdirs,</highlight></codeline>
<codeline lineno="451"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="452"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels</highlight></codeline>
<codeline lineno="453"><highlight class="normal">){</highlight></codeline>
<codeline lineno="454"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Timer" kindref="compound">Timer</ref><sp/>timer;</highlight></codeline>
<codeline lineno="455"><highlight class="normal"><sp/><sp/>timer.<ref refid="classrichdem_1_1Timer_1a6c1403aed0cc07ac87309e63a87d2217" kindref="member">start</ref>();</highlight></codeline>
<codeline lineno="456"><highlight class="normal"></highlight></codeline>
<codeline lineno="457"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/>low_edges,high_edges;<sp/><sp/></highlight><highlight class="comment">//TODO:<sp/>Need<sp/>estimate<sp/>of<sp/>size</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="458"><highlight class="normal"></highlight></codeline>
<codeline lineno="459"><highlight class="normal"><sp/><sp/>RDLOG_ALG_NAME&lt;&lt;</highlight><highlight class="stringliteral">&quot;Flat<sp/>Resolution<sp/>(Barnes<sp/>2014)&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="460"><highlight class="normal"><sp/><sp/>RDLOG_CITATION&lt;&lt;</highlight><highlight class="stringliteral">&quot;Barnes,<sp/>R.,<sp/>Lehman,<sp/>C.,<sp/>Mulla,<sp/>D.,<sp/>2014a.<sp/>An<sp/>efficient<sp/>assignment<sp/>of<sp/>drainage<sp/>direction<sp/>over<sp/>flat<sp/>surfaces<sp/>in<sp/>raster<sp/>digital<sp/>elevation<sp/>models.<sp/>Computers<sp/>&amp;<sp/>Geosciences<sp/>62,<sp/>128135.<sp/>doi:10.1016/j.cageo.2013.01.009&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="461"><highlight class="normal"></highlight></codeline>
<codeline lineno="462"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Setting<sp/>up<sp/>labels<sp/>matrix...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="463"><highlight class="normal"><sp/><sp/>labels.<ref refid="classrichdem_1_1Array2D_1a096db974fe765563929ee9802a37ec3e" kindref="member">templateCopy</ref>(elevations);</highlight></codeline>
<codeline lineno="464"><highlight class="normal"><sp/><sp/>labels.<ref refid="classrichdem_1_1Array2D_1a4baf4116eb21f3588877dfd0d0613aa2" kindref="member">resize</ref>(flowdirs);</highlight></codeline>
<codeline lineno="465"><highlight class="normal"><sp/><sp/>labels.<ref refid="classrichdem_1_1Array2D_1ac4557b9827f5cdb390697611c4a64b2d" kindref="member">setAll</ref>(0);</highlight></codeline>
<codeline lineno="466"><highlight class="normal"></highlight></codeline>
<codeline lineno="467"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Setting<sp/>up<sp/>flat<sp/>resolution<sp/>mask...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="468"><highlight class="normal"><sp/><sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1a096db974fe765563929ee9802a37ec3e" kindref="member">templateCopy</ref>(elevations);</highlight></codeline>
<codeline lineno="469"><highlight class="normal"><sp/><sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1a4baf4116eb21f3588877dfd0d0613aa2" kindref="member">resize</ref>(elevations);</highlight></codeline>
<codeline lineno="470"><highlight class="normal"><sp/><sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1ac4557b9827f5cdb390697611c4a64b2d" kindref="member">setAll</ref>(0);</highlight></codeline>
<codeline lineno="471"><highlight class="normal"><sp/><sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1a4fa61164507a4b9215e10102337bd784" kindref="member">setNoData</ref>(-1);</highlight></codeline>
<codeline lineno="472"><highlight class="normal"></highlight></codeline>
<codeline lineno="473"><highlight class="normal"><sp/><sp/>find_flat_edges(low_edges,<sp/>high_edges,<sp/>flowdirs,<sp/>elevations);</highlight></codeline>
<codeline lineno="474"><highlight class="normal"></highlight></codeline>
<codeline lineno="475"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(low_edges.size()==0){</highlight></codeline>
<codeline lineno="476"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(high_edges.size()&gt;0)</highlight></codeline>
<codeline lineno="477"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>RDLOG_WARN&lt;&lt;</highlight><highlight class="stringliteral">&quot;There<sp/>were<sp/>flats,<sp/>but<sp/>none<sp/>of<sp/>them<sp/>had<sp/>outlets!&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="478"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="479"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>RDLOG_WARN&lt;&lt;</highlight><highlight class="stringliteral">&quot;There<sp/>were<sp/>no<sp/>flats!&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="480"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">return</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="481"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="482"><highlight class="normal"></highlight></codeline>
<codeline lineno="483"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Labeling<sp/>flats...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="484"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>group_number=1;</highlight></codeline>
<codeline lineno="485"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i=low_edges.begin();i!=low_edges.end();++i)</highlight></codeline>
<codeline lineno="486"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels(i-&gt;x,i-&gt;y)==0)</highlight></codeline>
<codeline lineno="487"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>label_this(i-&gt;x,<sp/>i-&gt;y,<sp/>group_number++,<sp/>labels,<sp/>elevations);</highlight></codeline>
<codeline lineno="488"><highlight class="normal"></highlight></codeline>
<codeline lineno="489"><highlight class="normal"><sp/><sp/>RDLOG_MISC&lt;&lt;</highlight><highlight class="stringliteral">&quot;Unique<sp/>flats<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;group_number;</highlight></codeline>
<codeline lineno="490"><highlight class="normal"></highlight></codeline>
<codeline lineno="491"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Removing<sp/>flats<sp/>without<sp/>outlets<sp/>from<sp/>the<sp/>queue...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="492"><highlight class="normal"><sp/><sp/>std::deque&lt;GridCell&gt;<sp/>temp;</highlight></codeline>
<codeline lineno="493"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keyword">auto</highlight><highlight class="normal"><sp/>i=high_edges.begin();i!=high_edges.end();++i)</highlight></codeline>
<codeline lineno="494"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels(i-&gt;x,i-&gt;y)!=0)</highlight></codeline>
<codeline lineno="495"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>temp.push_back(*i);</highlight></codeline>
<codeline lineno="496"><highlight class="normal"></highlight></codeline>
<codeline lineno="497"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(temp.size()&lt;high_edges.size())<sp/><sp/></highlight><highlight class="comment">//TODO:<sp/>Prompt<sp/>for<sp/>intervention?</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="498"><highlight class="normal"><sp/><sp/><sp/><sp/>RDLOG_WARN&lt;&lt;</highlight><highlight class="stringliteral">&quot;Not<sp/>all<sp/>flats<sp/>have<sp/>outlets;<sp/>the<sp/>DEM<sp/>contains<sp/>sinks/pits/depressions!&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="499"><highlight class="normal"><sp/><sp/>high_edges=temp;</highlight></codeline>
<codeline lineno="500"><highlight class="normal"><sp/><sp/>temp.clear();</highlight></codeline>
<codeline lineno="501"><highlight class="normal"></highlight></codeline>
<codeline lineno="502"><highlight class="normal"><sp/><sp/>RDLOG_MEM_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;The<sp/>flat<sp/>height<sp/>vector<sp/>will<sp/>require<sp/>approximately<sp/>&quot;</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="503"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;&lt;(group_number*((long)</highlight><highlight class="keyword">sizeof</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal">))/1024/1024)</highlight></codeline>
<codeline lineno="504"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>&lt;&lt;</highlight><highlight class="stringliteral">&quot;MB<sp/>of<sp/>RAM.&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="505"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight></codeline>
<codeline lineno="506"><highlight class="normal"><sp/><sp/>RDLOG_PROGRESS&lt;&lt;</highlight><highlight class="stringliteral">&quot;Creating<sp/>flat<sp/>height<sp/>vector...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="507"><highlight class="normal"><sp/><sp/>std::vector&lt;int&gt;<sp/>flat_height(group_number);</highlight></codeline>
<codeline lineno="508"><highlight class="normal"></highlight></codeline>
<codeline lineno="509"><highlight class="normal"><sp/><sp/>BuildAwayGradient(</highlight></codeline>
<codeline lineno="510"><highlight class="normal"><sp/><sp/><sp/><sp/>flowdirs,<sp/>flat_mask,<sp/>high_edges,<sp/>flat_height,<sp/>labels</highlight></codeline>
<codeline lineno="511"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="512"><highlight class="normal"><sp/><sp/>BuildTowardsCombinedGradient(</highlight></codeline>
<codeline lineno="513"><highlight class="normal"><sp/><sp/><sp/><sp/>flowdirs,<sp/>flat_mask,<sp/>low_edges,<sp/>flat_height,<sp/>labels</highlight></codeline>
<codeline lineno="514"><highlight class="normal"><sp/><sp/>);</highlight></codeline>
<codeline lineno="515"><highlight class="normal"></highlight></codeline>
<codeline lineno="516"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Wall-time<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;timer.<ref refid="classrichdem_1_1Timer_1a94adfb2b628004e774b8d8ac4d6654b2" kindref="member">stop</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="517"><highlight class="normal">}</highlight></codeline>
<codeline lineno="518"><highlight class="normal"></highlight></codeline>
<codeline lineno="519"><highlight class="normal"></highlight></codeline>
<codeline lineno="520"><highlight class="normal"></highlight></codeline>
<codeline lineno="521"><highlight class="normal"></highlight><highlight class="comment">//d8_flats_alter_dem</highlight></codeline>
<codeline lineno="545"><highlight class="comment"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="546" refid="flat__resolution_8hpp_1a70a55d953a8bf1ac1471d6518466f11a" refkind="member"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/><ref refid="flat__resolution_8hpp_1a70a55d953a8bf1ac1471d6518466f11a" kindref="member">d8_flats_alter_dem</ref>(</highlight></codeline>
<codeline lineno="547"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;flat_mask,</highlight></codeline>
<codeline lineno="548"><highlight class="normal"><sp/><sp/></highlight><highlight class="keyword">const</highlight><highlight class="normal"><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>&amp;labels,</highlight></codeline>
<codeline lineno="549"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/>&amp;elevations</highlight></codeline>
<codeline lineno="550"><highlight class="normal">){</highlight></codeline>
<codeline lineno="551"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1ProgressBar" kindref="compound">ProgressBar</ref><sp/>progress;</highlight></codeline>
<codeline lineno="552"><highlight class="normal"></highlight></codeline>
<codeline lineno="553"><highlight class="normal"><sp/><sp/>RDLOG_ALG_NAME&lt;&lt;</highlight><highlight class="stringliteral">&quot;Calculating<sp/>D8<sp/>flow<sp/>directions<sp/>using<sp/>flat<sp/>mask...&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="554"><highlight class="normal"><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1a00e1878d9af52da7397d5965d923bbbd" kindref="member">start</ref>(<sp/>flat_mask.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>()*flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="555"><highlight class="normal"></highlight><highlight class="preprocessor"><sp/><sp/>#pragma<sp/>omp<sp/>parallel<sp/>for</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="556"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>x=1;x&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ad4d72d15f5a6199631051038088bb306" kindref="member">width</ref>()-1;x++){</highlight></codeline>
<codeline lineno="557"><highlight class="normal"><sp/><sp/><sp/><sp/>progress.<ref refid="classrichdem_1_1ProgressBar_1aa71fef0e8019c8dd64ed7c7e79466511" kindref="member">update</ref>(<sp/>x*flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()<sp/>);</highlight></codeline>
<codeline lineno="558"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>y=1;y&lt;flat_mask.<ref refid="classrichdem_1_1Array2D_1ab2e27ec2c5986596760a5256d92a2eb0" kindref="member">height</ref>()-1;y++){</highlight></codeline>
<codeline lineno="559"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels(x,y)==0)</highlight></codeline>
<codeline lineno="560"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="561"><highlight class="normal"></highlight></codeline>
<codeline lineno="562"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>higher[9];</highlight></codeline>
<codeline lineno="563"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;++n)</highlight></codeline>
<codeline lineno="564"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>higher[n]=elevations(x,y)&gt;elevations(x+dx[n],y+dy[n]);</highlight></codeline>
<codeline lineno="565"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//TODO:<sp/>nextafterf<sp/>is<sp/>the<sp/>floating<sp/>point<sp/>version;<sp/>should<sp/>use<sp/>an</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="566"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//overloaded<sp/>version<sp/>instead<sp/>to<sp/>be<sp/>able<sp/>to<sp/>handle<sp/>both<sp/>double<sp/>and<sp/>float</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="567"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>i=0;i&lt;flat_mask(x,y);++i)</highlight></codeline>
<codeline lineno="568"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>elevations(x,y)=nextafterf(elevations(x,y),std::numeric_limits&lt;U&gt;::infinity());</highlight></codeline>
<codeline lineno="569"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">for</highlight><highlight class="normal">(</highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>n=1;n&lt;=8;++n){</highlight></codeline>
<codeline lineno="570"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>nx=x+dx[n];</highlight></codeline>
<codeline lineno="571"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordtype">int</highlight><highlight class="normal"><sp/>ny=y+dy[n];</highlight></codeline>
<codeline lineno="572"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(labels(nx,ny)==labels(x,y))</highlight></codeline>
<codeline lineno="573"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="574"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(elevations(x,y)&lt;elevations(nx,ny))</highlight></codeline>
<codeline lineno="575"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">continue</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="576"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(!higher[n])</highlight></codeline>
<codeline lineno="577"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/><sp/>RDLOG_WARN&lt;&lt;</highlight><highlight class="stringliteral">&quot;Attempting<sp/>to<sp/>raise<sp/>(&quot;</highlight><highlight class="normal">&lt;&lt;x&lt;&lt;</highlight><highlight class="stringliteral">&quot;,&quot;</highlight><highlight class="normal">&lt;&lt;y&lt;&lt;</highlight><highlight class="stringliteral">&quot;)<sp/>resulted<sp/>in<sp/>an<sp/>invalid<sp/>alteration<sp/>of<sp/>the<sp/>DEM!&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="578"><highlight class="normal"><sp/><sp/><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="579"><highlight class="normal"><sp/><sp/><sp/><sp/>}</highlight></codeline>
<codeline lineno="580"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="581"><highlight class="normal"><sp/><sp/>RDLOG_TIME_USE&lt;&lt;</highlight><highlight class="stringliteral">&quot;Succeeded<sp/>in<sp/>=<sp/>&quot;</highlight><highlight class="normal">&lt;&lt;progress.<ref refid="classrichdem_1_1ProgressBar_1a69063c770d5eaee6299590de1d0294b6" kindref="member">stop</ref>()&lt;&lt;</highlight><highlight class="stringliteral">&quot;<sp/>s&quot;</highlight><highlight class="normal">;</highlight></codeline>
<codeline lineno="582"><highlight class="normal">}</highlight></codeline>
<codeline lineno="583"><highlight class="normal"></highlight></codeline>
<codeline lineno="584"><highlight class="normal"></highlight></codeline>
<codeline lineno="585"><highlight class="normal"></highlight></codeline>
<codeline lineno="586"><highlight class="normal"></highlight><highlight class="comment">//TODO:<sp/>Documentation</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="587"><highlight class="normal"></highlight><highlight class="keyword">template</highlight><highlight class="normal">&lt;</highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>T,<sp/></highlight><highlight class="keyword">class</highlight><highlight class="normal"><sp/>U&gt;</highlight></codeline>
<codeline lineno="588"><highlight class="normal"></highlight><highlight class="keywordtype">void</highlight><highlight class="normal"><sp/>barnes_flat_resolution_d8(<ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;T&gt;</ref><sp/>&amp;elevations,<sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;U&gt;</ref><sp/>&amp;flowdirs,<sp/></highlight><highlight class="keywordtype">bool</highlight><highlight class="normal"><sp/>alter){</highlight></codeline>
<codeline lineno="589"><highlight class="normal"><sp/><sp/><ref refid="d8__flowdirs_8hpp_1a772bed1aeafb81da6bfbc8b251526eaa" kindref="member">d8_flow_directions</ref>(elevations,flowdirs);</highlight></codeline>
<codeline lineno="590"><highlight class="normal"></highlight></codeline>
<codeline lineno="591"><highlight class="normal"><sp/><sp/><ref refid="classrichdem_1_1Array2D" kindref="compound">Array2D&lt;int32_t&gt;</ref><sp/>flat_mask,<sp/>labels;</highlight></codeline>
<codeline lineno="592"><highlight class="normal"></highlight></codeline>
<codeline lineno="593"><highlight class="normal"><sp/><sp/><ref refid="flat__resolution_8hpp_1a5a8557edf0f7687059df9ae900ada909" kindref="member">resolve_flats_barnes</ref>(elevations,flowdirs,flat_mask,labels);</highlight></codeline>
<codeline lineno="594"><highlight class="normal"></highlight></codeline>
<codeline lineno="595"><highlight class="normal"><sp/><sp/></highlight><highlight class="keywordflow">if</highlight><highlight class="normal">(alter){<sp/><sp/></highlight></codeline>
<codeline lineno="596"><highlight class="normal"><sp/><sp/><sp/><sp/></highlight><highlight class="comment">//NOTE:<sp/>If<sp/>this<sp/>value<sp/>appears<sp/>anywhere<sp/>an<sp/>error&apos;s<sp/>occurred</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="597"><highlight class="normal"><sp/><sp/><sp/><sp/>flowdirs.<ref refid="classrichdem_1_1Array2D_1ac4557b9827f5cdb390697611c4a64b2d" kindref="member">setAll</ref>(155);<sp/></highlight><highlight class="comment">//TODO</highlight><highlight class="normal"></highlight></codeline>
<codeline lineno="598"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="flat__resolution_8hpp_1a70a55d953a8bf1ac1471d6518466f11a" kindref="member">d8_flats_alter_dem</ref>(flat_mask,<sp/>labels,<sp/>elevations);</highlight></codeline>
<codeline lineno="599"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="d8__flowdirs_8hpp_1a772bed1aeafb81da6bfbc8b251526eaa" kindref="member">d8_flow_directions</ref>(elevations,flowdirs);</highlight></codeline>
<codeline lineno="600"><highlight class="normal"><sp/><sp/>}<sp/></highlight><highlight class="keywordflow">else</highlight><highlight class="normal"><sp/>{</highlight></codeline>
<codeline lineno="601"><highlight class="normal"><sp/><sp/><sp/><sp/><ref refid="flat__resolution_8hpp_1ad1f33db1167def82613eb31a59dfecb7" kindref="member">d8_flow_flats</ref>(flat_mask,labels,flowdirs);</highlight></codeline>
<codeline lineno="602"><highlight class="normal"><sp/><sp/>}</highlight></codeline>
<codeline lineno="603"><highlight class="normal"></highlight></codeline>
<codeline lineno="604"><highlight class="normal"><sp/><sp/>flowdirs.<ref refid="classrichdem_1_1Array2D_1a096db974fe765563929ee9802a37ec3e" kindref="member">templateCopy</ref>(elevations);</highlight></codeline>
<codeline lineno="605"><highlight class="normal">}</highlight></codeline>
<codeline lineno="606"><highlight class="normal"></highlight></codeline>
<codeline lineno="607"><highlight class="normal">}</highlight></codeline>
<codeline lineno="608"><highlight class="normal"></highlight></codeline>
<codeline lineno="609"><highlight class="normal"></highlight><highlight class="preprocessor">#endif</highlight></codeline>
    </programlisting>
    <location file="/z/richdem/include/richdem/flats/flat_resolution.hpp"/>
  </compounddef>
</doxygen>
